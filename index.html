<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verificador de Área Ambiental</title>
    <!-- Tailwind CSS para estilização -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- JSZip para descompactar arquivos .kmz -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- toGeoJSON para converter KML para GeoJSON -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/togeojson/0.16.0/togeojson.min.js"></script>
    <!-- Leaflet (biblioteca de mapa) CSS e JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <!-- Google Fonts para uma melhor tipografia -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Estilo para o spinner de carregamento */
        .loader {
            border: 5px solid #f3f3f3; /* Cinza claro */
            border-top: 5px solid #3498db; /* Azul */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #map {
            height: 400px;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex items-center justify-center min-h-screen p-4">
    <div class="w-full max-w-2xl mx-auto bg-white rounded-2xl shadow-lg p-6 md:p-8">
        <div class="text-center mb-6">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-900">Verificador de Área Ambiental</h1>
            <p class="text-gray-600 mt-2">Verifique se suas coordenadas estão em uma área de proteção carregada automaticamente.</p>
        </div>

        <!-- Status de Carregamento -->
        <div id="loading-section" class="text-center py-8">
            <div class="flex items-center justify-center">
                <div class="loader mr-3"></div>
                <p id="loading-status" class="text-gray-600">Carregando dados das áreas ambientais...</p>
            </div>
        </div>

        <!-- Conteúdo Principal (inicialmente oculto) -->
        <div id="main-content" class="hidden">
            <div class="space-y-4">
                <div>
                    <label for="latitude" class="block text-sm font-medium text-gray-700">Latitude</label>
                    <input type="number" id="latitude" placeholder="-23.0478667" class="mt-1 block w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                </div>
                <div>
                    <label for="longitude" class="block text-sm font-medium text-gray-700">Longitude</label>
                    <input type="number" id="longitude" placeholder="-44.6344310" class="mt-1 block w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                </div>
            </div>

            <div class="flex flex-col sm:flex-row gap-4 mt-6">
                <button id="getLocationBtn" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-200 shadow-sm flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    Usar Localização Atual
                </button>
                <button id="checkBtn" class="w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-200 shadow-sm">
                    Verificar
                </button>
            </div>

            <div id="result" class="mt-8 p-4 bg-gray-50 rounded-lg border border-gray-200 min-h-[100px] flex items-center justify-center">
                <p class="text-gray-500 text-center">O resultado da verificação aparecerá aqui.</p>
            </div>
            
            <!-- Container do Mapa -->
            <div id="map" class="mt-6"></div>
        </div>
    </div>

    <script>
        // Variáveis globais
        let geojsonData = null;
        let map = null;
        let userMarker = null;
        let areaLayer = null;

        // URL pública do arquivo KMZ via jsDelivr CDN para maior confiabilidade
        const kmzFileUrl = 'https://cdn.jsdelivr.net/gh/brenderrangel/kmz@main/AREAS_PROTEGIDAS_(V.%2024.2).kmz';

        // Elementos da UI
        const loadingSection = document.getElementById('loading-section');
        const loadingStatus = document.getElementById('loading-status');
        const mainContent = document.getElementById('main-content');
        const latitudeInput = document.getElementById('latitude');
        const longitudeInput = document.getElementById('longitude');
        const getLocationBtn = document.getElementById('getLocationBtn');
        const checkBtn = document.getElementById('checkBtn');
        const resultDiv = document.getElementById('result');

        // Funções de verificação de polígono
        function isPointInRing(point, ring) {
            const x = point[0], y = point[1];
            let isInside = false;
            for (let i = 0, j = ring.length - 1; i < ring.length; j = i++) {
                const xi = ring[i][0], yi = ring[i][1];
                const xj = ring[j][0], yj = ring[j][1];
                const intersect = ((yi > y) !== (yj > y)) && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
                if (intersect) isInside = !isInside;
            }
            return isInside;
        }

        function isPointInPolygon(point, polygon) {
            if (!isPointInRing(point, polygon[0])) return false;
            for (let i = 1; i < polygon.length; i++) {
                if (isPointInRing(point, polygon[i])) return false;
            }
            return true;
        }

        function isPointInFeature(point, feature) {
            const geom = feature.geometry;
            if (!geom) return false;
            switch (geom.type) {
                case 'Polygon': return isPointInPolygon(point, geom.coordinates);
                case 'MultiPolygon': return geom.coordinates.some(polygon => isPointInPolygon(point, polygon));
                case 'GeometryCollection': return geom.geometries.some(subGeom => isPointInFeature(point, { geometry: subGeom }));
                default: return false;
            }
        }
        
        // Inicializa o mapa
        function initMap() {
            if (map) return;
            map = L.map('map').setView([-14.235, -51.925], 4);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
        }

        // Carrega e processa o KMZ da URL
        async function loadKMZFromURL(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Falha na rede: ${response.statusText}`);
                }
                const arrayBuffer = await response.arrayBuffer();
                const zip = await JSZip.loadAsync(arrayBuffer);
                const kmlFile = Object.keys(zip.files).find(name => name.toLowerCase().endsWith('.kml'));
                if (!kmlFile) throw new Error('Nenhum arquivo KML encontrado no KMZ.');
                
                const kmlText = await zip.files[kmlFile].async('string');
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(kmlText, 'text/xml');
                geojsonData = toGeoJSON.kml(xmlDoc);
                
                if (!geojsonData || !geojsonData.features) {
                     throw new Error('A conversão para GeoJSON falhou.');
                }

                loadingSection.classList.add('hidden');
                mainContent.classList.remove('hidden');
                initMap();

            } catch (error) {
                console.error('Erro ao carregar ou processar o arquivo KMZ:', error);
                loadingStatus.innerHTML = `<p class="text-red-500">Falha ao carregar o arquivo da URL. Verifique o link e as permissões de CORS.</p>`;
            }
        }

        // Obtém localização atual
        function getCurrentLocation() {
            if (navigator.geolocation) {
                resultDiv.innerHTML = `<p class="text-gray-500 text-center">Obtendo sua localização...</p>`;
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        latitudeInput.value = lat.toFixed(6);
                        longitudeInput.value = lon.toFixed(6);
                        resultDiv.innerHTML = `<p class="text-gray-500 text-center">Localização obtida. Clique em "Verificar".</p>`;
                        if(map) {
                            map.flyTo([lat, lon], 13);
                            if(userMarker) userMarker.setLatLng([lat, lon]);
                            else userMarker = L.marker([lat, lon]).addTo(map);
                        }
                    },
                    (error) => {
                        let errorMessage = 'Erro ao obter localização: ';
                        switch (error.code) {
                            case error.PERMISSION_DENIED: errorMessage += "Permissão negada."; break;
                            case error.POSITION_UNAVAILABLE: errorMessage += "Localização indisponível."; break;
                            case error.TIMEOUT: errorMessage += "A requisição expirou."; break;
                            default: errorMessage += "Ocorreu um erro desconhecido."; break;
                        }
                        resultDiv.innerHTML = `<p class="text-red-500 text-center">${errorMessage}</p>`;
                    }
                );
            } else {
                resultDiv.innerHTML = `<p class="text-red-500 text-center">Geolocalização não é suportada por este navegador.</p>`;
            }
        }
        
        // Verifica as coordenadas
        function checkCoordinates() {
            const lat = parseFloat(latitudeInput.value);
            const lon = parseFloat(longitudeInput.value);

            if (isNaN(lat) || isNaN(lon)) {
                resultDiv.innerHTML = `<p class="text-red-500 text-center">Por favor, insira coordenadas válidas.</p>`;
                return;
            }
            if (!geojsonData) {
                resultDiv.innerHTML = `<p class="text-red-500 text-center">Dados do KMZ ainda não foram carregados.</p>`;
                return;
            }

            if (userMarker) map.removeLayer(userMarker);
            if (areaLayer) map.removeLayer(areaLayer);

            const userPoint = [lon, lat];
            let foundArea = geojsonData.features.find(feature => isPointInFeature(userPoint, feature));

            userMarker = L.marker([lat, lon]).addTo(map)
                .bindPopup(`<b>Coordenadas:</b><br>Lat: ${lat}<br>Lon: ${lon}`)
                .openPopup();

            if (foundArea) {
                const name = foundArea.properties.name || 'Nome não disponível';
                const description = foundArea.properties.description || 'Sem descrição.';
                resultDiv.innerHTML = `
                    <div class="text-left w-full p-4 bg-green-100 border border-green-300 rounded-lg">
                        <h3 class="font-bold text-lg text-green-800">✅ DENTRO de Área Ambiental!</h3>
                        <p class="mt-2"><strong class="font-semibold text-gray-800">Nome:</strong> ${name}</p>
                        <div class="mt-2"><strong class="font-semibold text-gray-800">Descrição:</strong><div class="mt-1 text-sm text-gray-700 max-h-40 overflow-y-auto">${description}</div></div>
                    </div>`;
                areaLayer = L.geoJSON(foundArea.geometry, { style: { color: "#ff7800", weight: 5, opacity: 0.65 } }).addTo(map);
                const combinedBounds = areaLayer.getBounds().extend(userMarker.getLatLng());
                map.flyToBounds(combinedBounds, {padding: [50, 50]});
            } else {
                resultDiv.innerHTML = `
                    <div class="text-left w-full p-4 bg-blue-100 border border-blue-300 rounded-lg">
                        <h3 class="font-bold text-lg text-blue-800">❌ FORA de Área Ambiental.</h3>
                        <p class="mt-2 text-gray-700">A coordenada informada não se encontra dentro de nenhuma área de proteção registrada no arquivo.</p>
                    </div>`;
                map.flyTo([lat, lon], 13);
            }
        }

        // Event Listeners
        getLocationBtn.addEventListener('click', getCurrentLocation);
        checkBtn.addEventListener('click', checkCoordinates);
        
        // Inicialização da aplicação
        document.addEventListener('DOMContentLoaded', () => {
            loadKMZFromURL(kmzFileUrl);
        });
    </script>
</body>
</html>
